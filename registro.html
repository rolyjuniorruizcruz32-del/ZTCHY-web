<!-- Asegúrate de que este script esté en el <head> -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// 1. CONFIGURACIÓN (REEMPLAZA CON TUS DATOS)
const SUPABASE_URL = 'https://tu-proyecto.supabase.co';
const SUPABASE_ANON_KEY = 'tu-clave-anon-aqui';

// 2. INICIALIZACIÓN ÚNICA (Evita el error "already declared")
let supabaseClient;
try {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("✅ Conectado a Supabase");
} catch (e) {
    console.error("❌ Error de configuración:", e.message);
}

// 3. MANEJO DEL FORMULARIO
document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // EVITA QUE LA PÁGINA SE BORRE/RECARGUE
        
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Procesando...";
        btn.disabled = true;

        const formData = new FormData(form);
        const email = formData.get('email');
        const password = formData.get('password');
        const nombre = formData.get('nombre');

        try {
            // A. Registrar en Supabase Auth
            const { data, error: authError } = await supabaseClient.auth.signUp({
                email,
                password,
                options: { data: { full_name: nombre } }
            });

            if (authError) throw authError;

            // B. Generar Código
            const codigo = Math.floor(100000 + Math.random() * 900000).toString();

            // C. Guardar en Base de Datos
            const { error: dbError } = await supabaseClient
                .from('codigos_verificacion')
                .insert([{ 
                    email: email, 
                    codigo: codigo, 
                    usado: false,
                    expira_en: new Date(Date.now() + 15 * 60 * 1000).toISOString()
                }]);

            if (dbError) throw dbError;

            // D. Enviar Email (Llamada a tu API de Vercel)
            const response = await fetch('/api/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, codigo, nombre, tipo: 'registro' })
            });

            if (!response.ok) throw new Error("Error al enviar el correo");

            alert("¡Código enviado! Revisa tu bandeja de entrada.");
            // Redirigir al archivo que tienes en GitHub
            window.location.href = 'verificar-correo-electronico.html?email=' + encodeURIComponent(email);

        } catch (err) {
            alert("Error: " + err.message);
            console.error(err);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
});
</script>
